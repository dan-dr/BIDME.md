<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirecting via BidMe...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      text-align: center;
      padding: 2rem;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: #58a6ff;
      margin-bottom: 1rem;
    }
    .message {
      font-size: 1rem;
      color: #8b949e;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">BidMe</div>
    <p class="message"><span class="spinner"></span>Redirecting via BidMe...</p>
  </div>
  <script>
    (function () {
      var params = new URLSearchParams(window.location.search);
      var dest = params.get("dest");
      var bannerId = params.get("id") || "unknown";
      var referrer = params.get("ref") || document.referrer || "direct";

      if (!dest) {
        document.querySelector(".message").textContent = "No destination specified.";
        return;
      }

      try {
        dest = decodeURIComponent(dest);
      } catch (e) {
        // use as-is if decode fails
      }

      // Extract repo from the page URL path: /{owner}/{repo}/.bidme/redirect.html
      var pathParts = window.location.pathname.split("/").filter(Boolean);
      var owner = pathParts[0] || "";
      var repo = pathParts[1] || "";

      // Append UTM params to destination
      var separator = dest.indexOf("?") === -1 ? "?" : "&";
      var repoSlug = owner && repo ? owner + "/" + repo : "";
      dest = dest + separator + "source=bidme" + (repoSlug ? "&repo=" + encodeURIComponent(repoSlug) : "");

      // Fire repository_dispatch for click tracking
      function redirect() {
        window.location.href = dest;
      }

      if (owner && repo) {
        var apiUrl = "https://api.github.com/repos/" + owner + "/" + repo + "/dispatches";
        try {
          fetch(apiUrl, {
            method: "POST",
            headers: { "Accept": "application/vnd.github.v3+json" },
            body: JSON.stringify({
              event_type: "bidme-click",
              client_payload: {
                banner_id: bannerId,
                referrer: referrer,
                timestamp: new Date().toISOString()
              }
            })
          }).then(redirect).catch(redirect);
        } catch (e) {
          redirect();
        }
      }

      // Auto-redirect after 1 second regardless
      setTimeout(redirect, 1000);
    })();
  </script>
</body>
</html>
