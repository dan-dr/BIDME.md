name: "BidMe: E2E Test"

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      # Ensure a test banner SVG exists in the repo
      - name: "Setup: Create test banner"
        run: |
          BANNER_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/.bidme/test/banner.svg"
          mkdir -p .bidme/test
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="300"><rect width="800" height="300" fill="#4a90d9"/><text x="400" y="160" text-anchor="middle" fill="white" font-size="40">Test Banner</text></svg>' > .bidme/test/banner.svg
          git config user.name "BidMe Bot"
          git config user.email "bidme-bot@users.noreply.github.com"
          git add .bidme/test/banner.svg
          if git diff --cached --quiet; then
            echo "Test banner already exists in repo"
          else
            git commit -m "chore: add test banner for E2E"
            git push origin main
            sleep 5
          fi
          # Verify the banner is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BANNER_URL")
          echo "Banner URL status: $HTTP_CODE"
          echo "banner_url=$BANNER_URL" >> "$GITHUB_OUTPUT"
          echo "✅ Test banner ready at: $BANNER_URL"
        id: setup

      # ─────────────────────────────────────────────────
      # STEP 1: Open a bidding period (creates issue)
      # ─────────────────────────────────────────────────
      - name: "Step 1: Open bidding period"
        id: open
        run: |
          bun run src/cli.ts open-bidding
          ISSUE_NUMBER=$(bun -e "
            const data = JSON.parse(await Bun.file('.bidme/data/current-period.json').text());
            console.log(data.issue_number);
          ")
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "✅ Bidding period opened on issue #$ISSUE_NUMBER"

      # ─────────────────────────────────────────────────
      # STEP 2: Post blocked bids (one per rule)
      # ─────────────────────────────────────────────────

      # 2a: Bid blocked by payment not verified (should be caught BEFORE content check)
      - name: "Step 2a: Post bid - payment not verified"
        id: bid_no_payment
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          BANNER_URL="${{ steps.setup.outputs.banner_url }}"
          BODY=$(cat <<BIDEOF
          Bid from unverified user

          \`\`\`yaml
          amount: 10
          banner_url: $BANNER_URL
          destination_url: https://example.com
          contact: bidder1@example.com
          \`\`\`
          BIDEOF
          )
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body="$BODY" --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted unverified payment bid (comment $COMMENT)"

      - name: "Step 2a: Process unverified payment bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_no_payment.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "paused\|unlinked_pending\|payment not linked"; then
            echo "✅ Bid correctly blocked: payment not verified"
          else
            echo "❌ Expected bid to be blocked for payment not verified"
            echo "Full output above. Check if payment check runs before content enforcement."
            exit 1
          fi

      # 2b: Bid blocked by amount too low
      - name: "Step 2b: Post bid - amount too low"
        id: bid_too_low
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          BANNER_URL="${{ steps.setup.outputs.banner_url }}"
          BODY=$(cat <<BIDEOF
          Low bid

          \`\`\`yaml
          amount: 1
          banner_url: $BANNER_URL
          destination_url: https://example.com
          contact: bidder2@example.com
          \`\`\`
          BIDEOF
          )
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body="$BODY" --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted low bid (comment $COMMENT)"

      - name: "Step 2b: Process low bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_too_low.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "at least\|too low\|minimum"; then
            echo "✅ Bid correctly rejected: amount too low (min $5)"
          else
            echo "❌ Expected bid to be rejected for low amount"
            exit 1
          fi

      # 2c: Bid blocked by bad increment (7 is not divisible by 2)
      - name: "Step 2c: Post bid - bad increment"
        id: bid_bad_increment
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          BANNER_URL="${{ steps.setup.outputs.banner_url }}"
          BODY=$(cat <<BIDEOF
          Bad increment bid

          \`\`\`yaml
          amount: 7
          banner_url: $BANNER_URL
          destination_url: https://example.com
          contact: bidder3@example.com
          \`\`\`
          BIDEOF
          )
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body="$BODY" --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted bad increment bid (comment $COMMENT)"

      - name: "Step 2c: Process bad increment bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_bad_increment.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "increment"; then
            echo "✅ Bid correctly rejected: bad increment ($7 not divisible by $2)"
          else
            echo "❌ Expected bid to be rejected for bad increment"
            exit 1
          fi

      # 2d: Bid blocked by invalid format (no yaml block)
      - name: "Step 2d: Post bid - invalid format"
        id: bid_bad_format
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='I want to bid $50 for the banner slot!' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted invalid format bid (comment $COMMENT)"

      - name: "Step 2d: Process invalid format bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_bad_format.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "parse\|Invalid\|format"; then
            echo "✅ Bid correctly rejected: invalid format"
          else
            echo "❌ Expected bid to be rejected for invalid format"
            exit 1
          fi

      # ─────────────────────────────────────────────────
      # STEP 3: Verify bot replied to blocked bidders with payment link
      # ─────────────────────────────────────────────────
      - name: "Step 3: Verify payment link replies"
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENTS=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments --jq '.[].body')
          echo "--- All comments on issue ---"
          echo "$COMMENTS"
          echo "--- End comments ---"
          if echo "$COMMENTS" | grep -qi "payment\|link your payment"; then
            echo "✅ Payment setup links found in issue comments"
          else
            echo "⚠️ No payment link found (checking if any bid reached payment check)"
          fi

      # ─────────────────────────────────────────────────
      # STEP 4: Post a valid bid that should go through
      # Temporarily disable payment requirement
      # ─────────────────────────────────────────────────
      - name: "Step 4: Temporarily allow unlinked bids for testing"
        run: |
          sed -i 's/require_payment_before_bid = true/require_payment_before_bid = false/' .bidme/config.toml
          sed -i 's/allow_unlinked_bids = false/allow_unlinked_bids = true/' .bidme/config.toml
          cat .bidme/config.toml | grep -E "require_payment|allow_unlinked"
          echo "✅ Config patched: payment enforcement disabled for test"

      - name: "Step 4: Post valid bid"
        id: bid_valid
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          BANNER_URL="${{ steps.setup.outputs.banner_url }}"
          # Use $12 to be higher than the $10 unlinked bid, and divisible by $2
          BODY=$(cat <<BIDEOF
          Valid bid from verified bidder

          \`\`\`yaml
          amount: 12
          banner_url: $BANNER_URL
          destination_url: https://example.com
          contact: valid-bidder@example.com
          \`\`\`
          BIDEOF
          )
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body="$BODY" --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted valid bid of \$12 (comment $COMMENT)"

      - name: "Step 4: Process valid bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_valid.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "accepted\|approved\|Bid recorded"; then
            echo "✅ Valid bid accepted successfully"
          else
            echo "❌ Expected valid bid to be accepted"
            echo "Note: Check if bid amount ($12) is higher than current highest and divisible by increment ($2)"
            exit 1
          fi

      # ─────────────────────────────────────────────────
      # STEP 5: Verify issue was updated correctly
      # ─────────────────────────────────────────────────
      - name: "Step 5: Verify issue body updated"
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          BODY=$(gh api repos/${{ github.repository }}/issues/$ISSUE --jq '.body')
          echo "$BODY"
          if echo "$BODY" | grep -q "Bid Table\|Current Top Bid"; then
            echo "✅ Issue body contains bid table"
          else
            echo "❌ Issue body missing bid table"
            exit 1
          fi
          if echo "$BODY" | grep -q '\$12'; then
            echo "✅ Issue body shows the $12 bid"
          else
            echo "⚠️ Issue body may not reflect the latest bid amount"
          fi

      # ─────────────────────────────────────────────────
      # STEP 6: Close the bidding period
      # ─────────────────────────────────────────────────
      - name: "Step 6: Close bidding period"
        run: |
          RESULT=$(bun run src/cli.ts close-bidding 2>&1)
          echo "$RESULT"
          if echo "$RESULT" | grep -q "Period closed\|winner"; then
            echo "✅ Bidding period closed successfully"
          else
            echo "❌ Failed to close bidding period"
            exit 1
          fi

      - name: "Step 6: Verify issue is closed"
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          STATE=$(gh api repos/${{ github.repository }}/issues/$ISSUE --jq '.state')
          echo "Issue state: $STATE"
          if [ "$STATE" = "closed" ]; then
            echo "✅ Issue correctly closed"
          else
            echo "❌ Issue should be closed but is: $STATE"
            exit 1
          fi

      # ─────────────────────────────────────────────────
      # STEP 7: Create a PR with the banner update and merge
      # ─────────────────────────────────────────────────
      - name: "Step 7: Create PR branch with data changes"
        id: pr_branch
        run: |
          git checkout .bidme/config.toml
          BRANCH="bidme/e2e-test-$(date +%s)"
          git checkout -b "$BRANCH"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore(bidme): e2e test data update"
            git push origin "$BRANCH"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: "Step 7: Create and merge PR"
        if: steps.pr_branch.outputs.has_changes == 'true'
        run: |
          BRANCH=${{ steps.pr_branch.outputs.branch }}
          PR_URL=$(gh pr create \
            --title "BidMe E2E Test: $(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --body "Automated E2E test run. This PR contains data changes from the test workflow." \
            --head "$BRANCH" \
            --base main 2>&1) || true
          echo "PR: $PR_URL"
          if echo "$PR_URL" | grep -q "github.com"; then
            PR_NUM=$(echo "$PR_URL" | grep -o '[0-9]*$')
            echo "✅ PR created: $PR_URL"
            gh pr merge "$PR_NUM" --merge --delete-branch || echo "⚠️ Could not auto-merge"
            echo "✅ PR merged"
          else
            echo "⚠️ PR creation output: $PR_URL"
          fi

      # ─────────────────────────────────────────────────
      # CLEANUP
      # ─────────────────────────────────────────────────
      - name: "Cleanup: Summary"
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "  BidMe E2E Test Summary"
          echo "=========================================="
          echo "  Issue: #${{ steps.open.outputs.issue_number }}"
          echo "  Tests run:"
          echo "    - Payment not verified: blocked"
          echo "    - Amount too low: rejected"
          echo "    - Bad increment: rejected"
          echo "    - Invalid format: rejected"
          echo "    - Valid bid: accepted"
          echo "  Period closed: yes"
          echo "=========================================="
