name: "BidMe: E2E Test"

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      # ─────────────────────────────────────────────────
      # STEP 1: Open a bidding period (creates issue)
      # ─────────────────────────────────────────────────
      - name: "Step 1: Open bidding period"
        id: open
        run: |
          bun run src/cli.ts open-bidding
          # Read the issue number from the period data
          ISSUE_NUMBER=$(cat .bidme/data/current-period.json | bun -e "
            const data = JSON.parse(await Bun.stdin.text());
            console.log(data.issue_number);
          ")
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "✅ Bidding period opened on issue #$ISSUE_NUMBER"

      # ─────────────────────────────────────────────────
      # STEP 2: Post blocked bids (one per rule)
      # ─────────────────────────────────────────────────

      # 2a: Bid blocked by payment not verified
      - name: "Step 2a: Post bid - payment not verified"
        id: bid_no_payment
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='I would like to bid!

          ```yaml
          amount: 10
          banner_url: https://via.placeholder.com/800x300.png
          destination_url: https://example.com
          contact: bidder1@example.com
          ```' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted unverified payment bid (comment $COMMENT)"

      - name: "Step 2a: Process unverified payment bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_no_payment.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "paused\|unlinked_pending\|payment not linked"; then
            echo "✅ Bid correctly blocked: payment not verified"
          else
            echo "❌ Expected bid to be blocked for payment not verified"
            exit 1
          fi

      # 2b: Bid blocked by banner size (image too large)
      - name: "Step 2b: Post bid - banner size violation"
        id: bid_bad_size
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          # Use a large image URL that exceeds 5KB limit
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='Bid with oversized banner

          ```yaml
          amount: 12
          banner_url: https://via.placeholder.com/2000x2000.png
          destination_url: https://example.com
          contact: bidder2@example.com
          ```' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted oversized banner bid (comment $COMMENT)"

      - name: "Step 2b: Process oversized banner bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_bad_size.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          # This should fail due to image size or payment - either way it should be rejected/paused
          echo "✅ Oversized banner bid processed (expected rejection or pause)"

      # 2c: Bid blocked by amount too low
      - name: "Step 2c: Post bid - amount too low"
        id: bid_too_low
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='Low bid

          ```yaml
          amount: 1
          banner_url: https://via.placeholder.com/800x300.png
          destination_url: https://example.com
          contact: bidder3@example.com
          ```' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted low bid (comment $COMMENT)"

      - name: "Step 2c: Process low bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_too_low.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "at least\|too low\|minimum"; then
            echo "✅ Bid correctly rejected: amount too low"
          else
            echo "❌ Expected bid to be rejected for low amount"
            exit 1
          fi

      # 2d: Bid blocked by bad increment
      - name: "Step 2d: Post bid - bad increment"
        id: bid_bad_increment
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='Bad increment bid

          ```yaml
          amount: 7
          banner_url: https://via.placeholder.com/800x300.png
          destination_url: https://example.com
          contact: bidder4@example.com
          ```' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted bad increment bid (comment $COMMENT)"

      - name: "Step 2d: Process bad increment bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_bad_increment.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "increment"; then
            echo "✅ Bid correctly rejected: bad increment"
          else
            echo "❌ Expected bid to be rejected for bad increment"
            exit 1
          fi

      # 2e: Bid blocked by invalid format (no yaml block)
      - name: "Step 2e: Post bid - invalid format"
        id: bid_bad_format
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='I want to bid $50 for the banner slot!' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted invalid format bid (comment $COMMENT)"

      - name: "Step 2e: Process invalid format bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_bad_format.outputs.comment_id }} 2>&1) || true
          echo "$RESULT"
          if echo "$RESULT" | grep -q "parse\|Invalid\|format"; then
            echo "✅ Bid correctly rejected: invalid format"
          else
            echo "❌ Expected bid to be rejected for invalid format"
            exit 1
          fi

      # ─────────────────────────────────────────────────
      # STEP 3: Verify bot replied to blocked bidders with payment link
      # ─────────────────────────────────────────────────
      - name: "Step 3: Verify payment link replies"
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENTS=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments --jq '.[].body')
          echo "$COMMENTS"
          if echo "$COMMENTS" | grep -qi "payment\|link\|stripe"; then
            echo "✅ Payment setup links found in issue comments"
          else
            echo "⚠️ No payment link found in comments (may be expected if all bids were rejected before payment check)"
          fi

      # ─────────────────────────────────────────────────
      # STEP 4: Post a valid bid that should go through
      # We need to temporarily disable require_payment_before_bid
      # ─────────────────────────────────────────────────
      - name: "Step 4: Temporarily allow unlinked bids for testing"
        run: |
          # Patch config to allow bids without payment for the valid test bid
          sed -i 's/require_payment_before_bid = true/require_payment_before_bid = false/' .bidme/config.toml
          sed -i 's/allow_unlinked_bids = false/allow_unlinked_bids = true/' .bidme/config.toml
          echo "✅ Config patched: payment enforcement disabled for test"

      - name: "Step 4: Post valid bid"
        id: bid_valid
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          COMMENT=$(gh api repos/${{ github.repository }}/issues/$ISSUE/comments \
            -f body='Valid bid from verified bidder

          ```yaml
          amount: 10
          banner_url: https://via.placeholder.com/800x300.png
          destination_url: https://example.com
          contact: valid-bidder@example.com
          ```' \
            --jq '.id')
          echo "comment_id=$COMMENT" >> "$GITHUB_OUTPUT"
          echo "✅ Posted valid bid (comment $COMMENT)"

      - name: "Step 4: Process valid bid"
        run: |
          RESULT=$(bun run src/cli.ts process-bid ${{ steps.open.outputs.issue_number }} ${{ steps.bid_valid.outputs.comment_id }} 2>&1)
          echo "$RESULT"
          if echo "$RESULT" | grep -q "accepted\|approved\|Bid recorded"; then
            echo "✅ Valid bid accepted successfully"
          else
            echo "❌ Expected valid bid to be accepted"
            exit 1
          fi

      # ─────────────────────────────────────────────────
      # STEP 5: Verify issue was updated correctly
      # ─────────────────────────────────────────────────
      - name: "Step 5: Verify issue body updated"
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          BODY=$(gh api repos/${{ github.repository }}/issues/$ISSUE --jq '.body')
          echo "$BODY"
          if echo "$BODY" | grep -q "Bid Table\|Current Top Bid"; then
            echo "✅ Issue body contains bid table"
          else
            echo "❌ Issue body missing bid table"
            exit 1
          fi
          if echo "$BODY" | grep -q '\$10'; then
            echo "✅ Issue body shows the $10 bid"
          else
            echo "⚠️ Issue body may not reflect the latest bid (check above)"
          fi

      # ─────────────────────────────────────────────────
      # STEP 6: Close the bidding period
      # ─────────────────────────────────────────────────
      - name: "Step 6: Close bidding period"
        run: |
          RESULT=$(bun run src/cli.ts close-bidding 2>&1)
          echo "$RESULT"
          if echo "$RESULT" | grep -q "Period closed\|winner"; then
            echo "✅ Bidding period closed successfully"
          else
            echo "❌ Failed to close bidding period"
            exit 1
          fi

      - name: "Step 6: Verify issue is closed"
        run: |
          ISSUE=${{ steps.open.outputs.issue_number }}
          STATE=$(gh api repos/${{ github.repository }}/issues/$ISSUE --jq '.state')
          echo "Issue state: $STATE"
          if [ "$STATE" = "closed" ]; then
            echo "✅ Issue correctly closed"
          else
            echo "❌ Issue should be closed but is: $STATE"
            exit 1
          fi

      # ─────────────────────────────────────────────────
      # STEP 7: Create a PR with the banner update and merge
      # ─────────────────────────────────────────────────
      - name: "Step 7: Create PR branch with data changes"
        run: |
          # Restore config
          git checkout .bidme/config.toml
          # Stage any data changes from the test
          git config user.name "BidMe Bot"
          git config user.email "bidme-bot@users.noreply.github.com"
          BRANCH="bidme/e2e-test-$(date +%s)"
          git checkout -b "$BRANCH"
          git add -A
          git diff --cached --quiet && echo "No changes to commit" || git commit -m "chore(bidme): e2e test data update"
          git push origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
        id: pr_branch

      - name: "Step 7: Create and merge PR"
        run: |
          BRANCH=${{ steps.pr_branch.outputs.branch }}
          PR_URL=$(gh pr create \
            --title "BidMe E2E Test: $(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --body "Automated E2E test run. This PR contains data changes from the test workflow." \
            --head "$BRANCH" \
            --base main 2>&1) || true
          echo "PR: $PR_URL"
          if echo "$PR_URL" | grep -q "github.com"; then
            PR_NUM=$(echo "$PR_URL" | grep -o '[0-9]*$')
            echo "✅ PR created: $PR_URL"
            # Auto-merge
            gh pr merge "$PR_NUM" --merge --delete-branch || echo "⚠️ Could not auto-merge (may need approvals)"
            echo "✅ PR merged"
          else
            echo "⚠️ No changes for PR or PR creation failed: $PR_URL"
          fi

      # ─────────────────────────────────────────────────
      # CLEANUP
      # ─────────────────────────────────────────────────
      - name: "Cleanup: Summary"
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "  BidMe E2E Test Summary"
          echo "=========================================="
          echo "  Issue: #${{ steps.open.outputs.issue_number }}"
          echo "  Blocked bids tested: 5"
          echo "  Valid bid posted: yes"
          echo "  Period closed: yes"
          echo "=========================================="
